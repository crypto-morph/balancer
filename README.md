# Balancer

A portfolio advisory tool for crypto. Advisory-only (no auto-trading) with hourly price ingestion, daily cool-off on rebalance actions, and a clean web UI.

- Project spec: docs/spec.md
- Data model and APIs: docs/spec.md#backend-and-db
- UI and testing: docs/spec.md#frontend-and-testing
- Operations and setup: docs/spec.md#operations-and-deployment

## Repository Structure

- docs/spec.md — Living specification (source of truth for design/decisions)
- docs/initial-data/
  - tokenlist.txt — Prototype portfolio snapshot (tab-delimited, GBP values)
  - cg-mapping.txt — Coingecko ID mapping list (first line is authoritative)
- Spec.md — Legacy spec with a relocation notice
- .env — Local secrets (e.g., COINGECKO)

## Quick Start

- Backend: Python (venv), SQLite. Config in .env (COINGECKO key).
- Frontend: Next.js + Tailwind + shadcn/ui.
- Runbook and detailed instructions live in docs/spec.md.

### One-liner with balancerctl

- Use the helper script to start both services and run tests:

```bash
./balancerctl start          # start frontend (Next.js dev) and backend loop
./balancerctl status         # check PIDs
./balancerctl test all       # run Python unit tests and Playwright E2E tests
./balancerctl stop           # stop both services
```

## Running the hourly pipeline

- Ensure `.env` is set (see Environment Variables below) and DB path is writable.
- Create and activate venv, install deps, then run once:

```bash
. .venv/bin/activate
python -m balancer.runner
```

### Cron example (hourly)

```
0 * * * * cd /path/to/balancer && . .venv/bin/activate && python -m balancer.runner >> runner.log 2>&1
```

### systemd timer (sketch)

- Service: call `python -m balancer.runner` in the repo directory with the venv activated (or use ExecStart with venv python).
- Timer: `OnCalendar=hourly`.

## Running the frontend (Next.js)

- Prereqs: Node 18+ and npm installed.
- Start the dev server:

```bash
cd web
npm install
npm run dev
# open http://localhost:3000
```

- API routes used by the UI:
  - GET `/api/portfolio` reads `../portfolio.json` (generated by the backend runner).
  - GET `/api/alerts` reads `../alerts.jsonl`.
  - GET `/api/indicators` reads from SQLite `balancer.db`.
  - POST `/api/positions/update` updates positions in SQLite.

- Environment (optional):
  - `DB_PATH` (default: `../balancer.db` from the web/ directory)
  - `LOG_PATH` (default: `../alerts.jsonl`)

- Notes:
  - If GBP/BTC values show as zero, re-run the backend exporter to regenerate `portfolio.json` with multi-currency fields:
    - `. .venv/bin/activate && python -m balancer.runner`
  - The dev server auto-reloads on file edits.

## balancerctl (Process Manager)

`balancerctl` is a small utility to manage the dev processes and tests safely without killing unrelated editors/terminals.

- Requirements:
  - Python venv at `.venv/` (used automatically if present)
  - Node 18+ with npm installed (frontend)

- Commands:
  - `start` — start frontend and backend
  - `stop` — stop frontend and backend
  - `restart` — restart both
  - `status` — show whether FE/BE are running and their PIDs
  - `start-fe` / `stop-fe` — manage only frontend
  - `start-be` / `stop-be` — manage only backend
  - `start-be-loop [interval]` — run backend `run_once()` on an interval (default 300s)
  - `test unit` — run Python unit tests (pytest)
  - `test e2e` — run Playwright tests (starts dev server automatically)
  - `test all` — run unit, then E2E tests

- Examples:

```bash
# prefer venv if available
python -m venv .venv && . .venv/bin/activate && pip install -r requirements-dev.txt

# install frontend deps once
(cd web && npm install)

# run services
./balancerctl start
./balancerctl status

# run tests
./balancerctl test unit
./balancerctl test e2e
./balancerctl test all

# pass args through to Playwright (after --)
./balancerctl test e2e -- --grep "portfolio"

# stop services
./balancerctl stop
```

- Implementation details:
  - Uses PID files in `.pids/` with logs: `.pids/frontend.log`, `.pids/backend.log`
  - Avoids `pkill`; only signals PIDs it started
  - Frontend runs `npm run dev` in `web/` at `http://localhost:3000`
  - Backend runs `balancer.runner.run_once()` in a loop; interval configurable

## Initial Data (prototype)

- docs/initial-data/tokenlist.txt
  - Columns: Token, Symbol, Price(£), Coins, Value(£), Average Buy Price(£)
  - Used by importer to seed assets/positions; currency symbols and thousands separators are normalized.
- docs/initial-data/cg-mapping.txt
  - Line 1: comma-separated Coingecko IDs used to fetch/match assets.
  - Remaining lines may contain pasted API rows; these are ignored by the importer.

## Status

MVP in planning. Spec is a living document; see docs/spec.md for current decisions and roadmap.

## Contributing and Docs

- Update the living spec at `docs/spec.md` when decisions change.
- Keep `docs/initial-data/` in sync with any prototype inputs used by importers.
- Prefer small, incremental changes with clear commit messages.

## Engineering Principles (summary)

- Env-driven config: All endpoints, timeouts, API keys, and feature flags read from `.env`.
- Modularity: HTTP clients (Coingecko, FRED, Fear&Greed) separated from business services (pricing, indicators, rules).
- Observability: JSONL alerts and structured logs for key events.
- Testability: Clients/services designed for dependency injection and mocking.

## Data Fetch and Icons (recap)

- Pricing: one Coingecko `coins/markets` request per run with all IDs and `vs_currency=GBP`.
- FX: derive USD from GBP via USDC-implied GBPUSD; store GBP->USD FX in `fx_rates`.
- BTC prices: derived from BTCUSD for `ccy=BTC` valuations.
- Icons: Next.js `/api/icons` fetches Coingecko image URLs (assets CDN) once and caches them on disk for 1 week at `.cache/icons.json`.
- Testability: Clients/services designed for dependency injection and mocking.

### Environment Variables

- COINGECKO: Coingecko API key (optional for public endpoints)
- FRED_API_KEY: FRED API key for DXY proxy (DTWEXBGS)
- DB_PATH: path to SQLite DB (default: balancer.db)
- LOG_PATH: alerts log path (default: alerts.jsonl)
- INITIAL_TOKENLIST: path to initial portfolio file (default: docs/initial-data/tokenlist.txt)
- CG_MAPPING_FILE: path to Coingecko IDs mapping (default: docs/initial-data/cg-mapping.txt)
- BASE_CCY: default valuation currency (default: USD)
- HTTP_TIMEOUT: request timeout seconds (default: 20)
- HTTP_RETRIES: number of retries (default: 2)
- COOLOFF_DAYS: rule cool-off in days (default: 1)
